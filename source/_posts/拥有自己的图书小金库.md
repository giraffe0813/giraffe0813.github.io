title: æ‹¥æœ‰è‡ªå·±çš„å›¾ä¹¦å°é‡‘åº“
toc: true
date: 2016-01-09 14:15:46
tags:
	- python
	- çˆ¬è™«
	- django
---
> åœ¨æ‰¾matering elasticsearch second editionè¿™æœ¬ä¹¦çš„æ—¶å€™ï¼Œåœ¨è®¸å¤šå¯ä»¥å…è´¹ä¸‹ç”µå­ä¹¦çš„ç½‘ç«™éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€ä»¥å°±ä¹°äº†[Geekbook](https://www.geekbooks.me/category)ä¸€ä¸ªæœˆçš„ä¼šå‘˜ï¼Œä¸ºäº†ä¸æµªè´¹å……ä¼šå‘˜çš„é’±ï¼Œå†³å®šæ’¸ä¸ªè„šæœ¬æŠŠå…¨ç«™çš„ä¹¦éƒ½ä¸‹ä¸‹æ¥,å¹¶ç”¨djangoæ­ä¸ªç®¡ç†åå°ã€‚å’Œ[æ´ªèŠ](https://github.com/KevinOfNeu)ï¼Œ[å¢ç¥](https://github.com/stephenluu)åˆ©ç”¨ç©ºé—²æ—¶é—´å¿™æ´»äº†å¿«ä¸¤å‘¨ï¼Œç»ˆäºæœ‰äº†è‡ªå·±çš„å›¾ä¹¦å°é‡‘åº“ï¼Œ5000+çš„ä¼˜è´¨è‹±æ–‡åŸç‰ˆç”µå­ä¹¦ï¼Œå“‡å’”å’”å’”å’”ï¼Œè¿™è¾ˆå­çš„ä¹¦éƒ½æœ‰äº†ã€‚
geekbookåƒä¸‡ä¸è¦æ€ªæˆ‘ä»¬å•Šï¼Œè°è®©ä½ ä¸å°æˆ‘ä»¬çš„~~ã€‚
**é¡¹ç›®åœ°å€ï¼š[github](https://github.com/giraffe0813/GeekBook)**

![å°é»„äºº](/images/xiaohuangren.gif)
<!-- more -->

### é‡åˆ°çš„å‘
è®°å½•ä¸‹é‡åˆ°çš„å‘ ä¸ç„¶å°±å¿˜äº†ğŸ˜‚
#### åªå¸¦cookie æ— æ³•ä¸‹è½½
æœ¬æ¥ä»¥ä¸ºåªè¦å¸¦ç€ç™»å½•ä¹‹åçš„cookieè¯·æ±‚ä¸‹è½½çš„åœ°å€(eg:https://www.geekbooks.me/books/56/48/c1955c13518f994167b11f7b7279/amazon_ec2_cookbook.pdf) å°±å¯ä»¥ä¸‹è½½äº†ï¼Œä¸è¿‡å‘ç°ä¸‹ä¸‹æ¥çš„å¹¶ä¸æ˜¯ä¹¦ï¼Œè€Œæ˜¯ç½‘ç«™ä¸Šä¹¦çš„è¯¦æƒ…é¡µçš„htmlã€‚å—åˆ°åšå®¢[CourseæŠ“ç«™å°ç»“](http://www.jianshu.com/p/c3dbf8294c33) çš„å¯å‘ï¼Œåˆç ”ç©¶äº†ä¸€ä¸‹è¯·æ±‚çš„headerã€‚
![header](/images/header.jpg)
å‘ç°é™¤äº†è¦å¸¦cookieä¹‹å¤–ï¼Œè¿˜è¦å¸¦æœ‰user_agentå’ŒRefererï¼Œreferæ˜¯è¡¨ç¤ºä»å“ªä¸ªé¡µé¢è®¿é—®å½“å‰é“¾æ¥ã€‚
æ‰€ä»¥ä¿®æ”¹äº†ä¸‹ä»£ç ï¼Œåœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥user-agentå’Œrefererä¹‹åï¼Œé—®é¢˜å°±è§£å†³äº†,éƒ¨åˆ†ä»£ç å¦‚ä¸‹
```python
 cookie = cookielib.MozillaCookieJar()
 # get cookie from file
 cookie.load('../data/cookie4geek.data', ignore_discard=True, ignore_expires=True)
 handler = urllib2.HTTPCookieProcessor(cookie)
 opener = urllib2.build_opener(handler)
 # add header
 opener.addheaders = [('User-agent', 'Mozilla/5.0'), ("Referer", url)]
```
#### ä¸‹è½½æ–‡ä»¶çš„æ—¶å€™ä¸æ˜¾ç¤ºè¿›åº¦
å¯ä»¥ä¸‹è½½æ–‡ä»¶ä¹‹åï¼Œå¸Œæœ›å¯ä»¥åœ¨ä¸‹è½½æ–‡ä»¶çš„æ—¶å€™æ˜¾ç¤ºä¸‹è½½è¿›åº¦ï¼Œè®©æˆ‘ä»¬çŸ¥é“ä»–åœ¨å·¥ä½œã€‚ã€‚ã€‚ã€‚ç›´æ¥åœ¨stackoverflowä¸ŠæŠ„äº†æ®µä»£ç ï¼Œè¿™ä¸ªé—®é¢˜ä¹Ÿæ„‰å¿«çš„è§£å†³äº†ã€‚
```python
        u = opener.open("https://www.geekbooks.me" + url)
        print "Preparing to download..."
        # f with directory
        if os.path.exists(conf_books_dir + category + "/" + file_name) and detect_book(
                (conf_books_dir + category + "/" + file_name)):
            continue
        f = open(conf_books_dir + category + "/" + file_name, 'wb')
        meta = u.info()
        file_size = int(meta.getheaders("Content-Length")[0])
        print "Downloading: %s Bytes: %s" % (file_name, file_size)
        file_size_dl = 0
        block_sz = 8192
        while True:
            buffer = u.read(block_sz)
            if not buffer:
                break
            file_size_dl += len(buffer)
            f.write(buffer)
            status = r"%10d  [%3.2f%%]" % (file_size_dl, file_size_dl * 100. / file_size)
            status = status + chr(8) * (len(status) + 1)
            print status,
        f.close()
```
#### ä¸€æœ¬ä¸€æœ¬ä¸‹è½½é€Ÿåº¦å¤ªæ…¢
è¿™ä¸ªåªèƒ½æœæ–­ä¸Šå¤šçº¿ç¨‹äº†ã€‚ã€‚ã€‚
```python
def download_work():
    f = open("../data/detailurl.txt", "r")
    books = []
    destDir = ""
    tmp = ""
    for line in f:
        if not (line.strip()).startswith("/"):
            tmp += "/" + line.strip()
            destDir = tmp
        else:
            # desDir
            book = Book(destDir, line.strip())
            books.append(book)
            tmp = ""
    pool = threadpool.ThreadPool(conf_thread_count)
    reqs = threadpool.makeRequests(lambda book: book.download(), books)
    [pool.putRequest(req) for req in reqs]
    pool.wait()
```
#### æ— æ³•å±•ç¤ºä¸‹è½½ä¹¦çš„å…·ä½“ä¿¡æ¯
é™¤äº†å°†ä¹¦ä¸‹è½½ä¸‹æ¥ï¼Œè¿˜æƒ³å°†ä¹¦çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œæ¯”å¦‚:ä½œè€…ï¼Œç®€æ´ï¼Œå‡ºç‰ˆå¹´ä»½ï¼Œå°é¢ï¼Œæ ‡ç­¾ç­‰ç­‰ã€‚ã€‚æœ€å¥½å¯ä»¥æ ¹æ®ä½œè€…ï¼Œé¢˜ç›®è¿›è¡Œæœç´¢ã€‚æœ¬æ¥æƒ³è‡ªå·±å†™ä¸ªç½‘ç«™å‡ºæ¥ï¼Œä½†æ˜¯åˆæ²¡æœ‰æ—¶é—´ã€‚è¿˜å¥½ä¹‹å‰å­¦å”æ¨èè¿‡djangoï¼Œç”¨djangoæ­ä¸ªç®¡ç†åå°ç®€ç›´ä¸è¦å¤ªæ–¹ä¾¿å¥½ä¹ˆï¼Œé…ç½®nginxï¼Œsupervisorçš„æ—¶é—´éƒ½æ¯”å†™ä»£ç çš„æ—¶é—´é•¿ğŸ‘…ï¼Œè¿˜å¯ä»¥å¾ˆæ–¹ä¾¿å®šä¹‰æƒ³æœç´¢çš„å­—æ®µå’Œæƒ³å±•ç¤ºçš„å­—æ®µã€‚æ ·å¼æ˜¯ä¸‘äº†ä¸€ä¸¢ä¸¢ï¼Œä½†è‡ªå·±ç”¨ä¹Ÿæ— æ‰€è°“ã€‚
### æˆå“
![admin](/images/admin.jpg)

### Summary
ä¾é ç©ºé—²æ—¶é—´å¯ä»¥åšç‚¹æƒ³åšçš„äº‹ï¼Œä¹Ÿæ˜¯è›®å¥½çš„~~ã€‚ç”¨pythonå†™è„šæœ¬çœŸçš„å¾ˆæ–¹ä¾¿ï¼ŒåŸºæœ¬ä¸ç”¨è‡ªå·±é€ è½®å­ï¼Œç”¨å®ƒè‡ªå¸¦çš„æ¨¡å—å°±å¯ä»¥å®Œæˆäº†ã€‚ç”¨djangoæ­ç®¡ç†åå°ä¹Ÿæ˜¯å¿«çš„ä¸è¦ä¸è¦çš„ã€‚ä¸€å‘¨å¤šçš„æ—¶é—´æ¢4000+çš„ä¹¦å¾ˆå€¼å•Šï¼Œä½†æ˜¯ã€‚ã€‚ã€‚ã€‚æœåŠ¡å™¨+å­˜å‚¨å¹³å‡ä¸€å¤©çš„æˆæœ¬å°±è¦10å—ã€‚ã€‚ã€‚æ˜¯ä¸æ˜¯å¾—æƒ³ä¸ªæ³•å­ï¼Œçœ‹èƒ½ä¸èƒ½ç”¨è¿™äº›ç”µå­ä¹¦æŒ£ç‚¹é’±å•Šã€‚ã€‚ã€‚ã€‚æƒ³åˆ°è¿™ã€‚ã€‚ã€‚çªç„¶æ²¡é‚£ä¹ˆå¼€å¿ƒäº†ã€‚ã€‚ã€‚
![lingluan](/images/lingluan.jpg)







